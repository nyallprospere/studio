/**
 * @file Firebase Security Rules
 * @version 2
 *
 * @description
 * This ruleset enforces a public-read, owner-write model for most content, with specific exceptions.
 *
 * Data Structure:
 * - Top-level collections such as `parties`, `candidates`, `elections`, `news`, etc., store public data.
 * - The `settings` collection contains singleton documents for global configurations.
 * - Comments are stored as subcollections under news articles (`/news/{newsId}/comments/{commentId}`).
 * - Reports are stored at the top-level collection `/reports/{reportId}`.
 *
 * Key Security Decisions:
 * - **Public Read Access:** Most top-level collections allow public read access (`get`, `list`).
 * - **Owner-Only Writes:** Write access (`create`, `update`, `delete`) to these collections is restricted to authenticated users.
 * - **Singleton Documents:** The `settings` documents (`/settings/pageLayouts`, `/settings/site`) restrict all writes.
 * - **News Article Comments**: Authenticated users can create comments. Updates/deletes are not permitted for comments.
 * - **Reports**: Write access is denied to all clients.
 * - **No User Data Segregation:** This ruleset does NOT include any concept of user-specific private data or user-owned data trees.
 *
 * Denormalization for Authorization:
 *  - No denormalization is necessary as ownership is implicit by being signed in to create or update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read the site settings, but nobody to modify them.
     * @path /databases/{database}/documents/settings/site
     * @allow (get, list): Always.
     * @deny (create, update, delete): Always.
     * @principle Public read-only for global site settings.
     */
    match /settings/site {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read the page layouts, but nobody to modify them.
     * @path /databases/{database}/documents/settings/pageLayouts
     * @allow (get, list): Always.
     * @deny (create, update, delete): Always.
     * @principle Public read-only for global page layouts.
     */
    match /settings/pageLayouts {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read mailing list subscribers.  Anyone can create a mailing list subscriber. No updates or deletes allowed.
     * @path /databases/{database}/documents/mailing_list_subscribers/{subscriberId}
     * @allow (get, list): Always.
     * @allow (create): if isSignedIn();
     * @deny (update, delete): Always.
     * @principle Public read for subscribers, authenticated create only.
     */
    match /mailing_list_subscribers/{subscriberId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read parties, and any logged in user to create, update, and delete parties.
     * @path /databases/{database}/documents/parties/{partyId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for parties, authenticated create/update/delete only.
     */
    match /parties/{partyId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read party logos, and any logged in user to create, update, and delete party logos.
     * @path /databases/{database}/documents/party_logos/{partyLogoId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for party logos, authenticated create/update/delete only.
     */
    match /party_logos/{partyLogoId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read events, and any logged in user to create, update, and delete events.
     * @path /databases/{database}/documents/events/{eventId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for events, authenticated create/update/delete only.
     */
    match /events/{eventId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read candidates, and any logged in user to create, update, and delete candidates.
     * @path /databases/{database}/documents/candidates/{candidateId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for candidates, authenticated create/update/delete only.
     */
    match /candidates/{candidateId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read archived candidates, and any logged in user to create, update, and delete archived candidates.
     * @path /databases/{database}/documents/archived_candidates/{archivedCandidateId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for archived candidates, authenticated create/update/delete only.
     */
    match /archived_candidates/{archivedCandidateId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read elections, and any logged in user to create, update, and delete elections.
     * @path /databases/{database}/documents/elections/{electionId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for elections, authenticated create/update/delete only.
     */
    match /elections/{electionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read polling data, and any logged in user to create, update, and delete polling data.
     * @path /databases/{database}/documents/polling_data/{pollingDataId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for polling data, authenticated create/update/delete only.
     */
    match /polling_data/{pollingDataId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read constituencies, and any logged in user to create, update, and delete constituencies.
     * @path /databases/{database}/documents/constituencies/{constituencyId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for constituencies, authenticated create/update/delete only.
     */
    match /constituencies/{constituencyId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read election results, and any logged in user to create, update, and delete election results.
     * @path /databases/{database}/documents/election_results/{electionResultId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for election results, authenticated create/update/delete only.
     */
    match /election_results/{electionResultId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

   /**
     * @description Allows anyone to read user activity, and any logged in user to create, update, and delete user activity.
     * @path /databases/{database}/documents/user_activity/{activityId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for user activity, authenticated create/update/delete only.
     */
    match /user_activity/{activityId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

   /**
     * @description Allows anyone to read regions, and any logged in user to create, update, and delete regions.
     * @path /databases/{database}/documents/regions/{regionId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for regions, authenticated create/update/delete only.
     */
    match /regions/{regionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

   /**
     * @description Allows anyone to read user maps, and any logged in user to create, update, and delete user maps.
     * @path /databases/{database}/documents/user_maps/{userMapId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for user maps, authenticated create/update/delete only.
     */
    match /user_maps/{userMapId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read ads, and any logged in user to create, update, and delete ads.
     * @path /databases/{database}/documents/ads/{adId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for ads, authenticated create/update/delete only.
     */
    match /ads/{adId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

   /**
     * @description Allows anyone to read news articles, and any logged in user to create, update, and delete news articles.
     * @path /databases/{database}/documents/news/{newsId}
     * @allow (get, list): Always.
     * @allow (create, update, delete): if isSignedIn();
     * @principle Public read for news articles, authenticated create/update/delete only.
     */
    match /news/{newsId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;

       /**
         * @description Allows authenticated users to create comments under news articles.
         * @path /databases/{database}/documents/news/{newsId}/comments/{commentId}
         * @allow (get, list): Always.
         * @allow (create): if isSignedIn();
         * @deny (update, delete): Always.
         * @principle Authenticated users can create comments, but not update or delete them.
         */
        match /comments/{commentId} {
          allow get: if true;
          allow list: if true;
          allow create: if isSignedIn();
          allow update: if false;
          allow delete: if false;
        }
    }

    /**
     * @description Denies all access to the reports collection.
     * @path /databases/{database}/documents/reports/{reportId}
     * @deny (get, list, create, update, delete): Always.
     * @principle No client-side access to reports.
     */
    match /reports/{reportId} {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

  }

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }
}