/**
 * @fileoverview Firestore Security Rules for the political data platform.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on a combination of
 * public readability where appropriate and ownership-based write access.
 * It leans towards a more restrictive security posture, requiring explicit
 * rules for each data entity and operation.
 *
 * Data Structure:
 * The Firestore database is organized into top-level collections for entities
 * like parties, candidates, elections, and constituencies. Some collections,
 * like user_activity, store data related to user actions. Several singleton
 * settings documents exist in the `/settings` collection group.
 *
 * Key Security Decisions:
 * - Public Read Access: Collections like `parties`, `elections`,
 *   `constituencies`, `news`, and `ads` are generally readable by all users.
 * - Ownership-Based Writes: Write access to collections like `user_activity` and
 *   `user_maps` is restricted to the authenticated user.
 * - Admin Privileges: No explicit admin roles are defined. All rules are based
 *   on user authentication and document ownership.
 * - Denormalization for Authorization: The rules avoid complex `get()` calls
 *   by assuming that necessary authorization data (e.g., ownership) is
 *   available directly within the document being secured.
 * - The rules do not enforce a strict schema, they are written for prototyping purposes.
 *
 * Error Context:
 * The error reported in `src/app/admin/logos/logo-upload-dialog.tsx (192:37)` indicates that the
 * authenticated user "admin@revolucianize.com" (UID: 2x2K7xGgyvPC5xHervPDIKMo5Q13) does not have
 * write permissions to the `party_logos` collection. Since admin roles are not defined in the IR,
 * the rules must be updated to grant write access based on some other authorization mechanism, such
 * as a designated owner or role. As a safe default, the rules will be adjusted to limit access
 * to party logos to authenticated users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any user to read mailing list subscribers, but restricts creation and modification.
     * @path /mailing_list_subscribers/{subscriberId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /mailing_list_subscribers/{subscriberId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read party information, but restricts creation and modification.
     * @path /parties/{partyId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /parties/{partyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to create, update, and delete party logos.
     * @path /party_logos/{partyLogoId}
     * @allow get, list: if true
     * @allow create, update, delete: if isSignedIn();
     * @deny get, list: if false
     * @principle Authenticated users can manage party logos.
     */
    match /party_logos/{partyLogoId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows any user to read event information, but restricts creation and modification.
     * @path /events/{eventId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read candidate information, but restricts creation and modification.
     * @path /candidates/{candidateId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /candidates/{candidateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read archived candidate data, but restricts creation and modification.
     * @path /archived_candidates/{archivedCandidateId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /archived_candidates/{archivedCandidateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read election information, but restricts creation and modification.
     * @path /elections/{electionId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /elections/{electionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read polling data, but restricts creation and modification.
     * @path /polling_data/{pollingDataId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /polling_data/{pollingDataId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read constituency information, but restricts creation and modification.
     * @path /constituencies/{constituencyId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /constituencies/{constituencyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read election results, but restricts creation and modification.
     * @path /election_results/{electionResultId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /election_results/{electionResultId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read page layouts, but restricts creation and modification.
     * @path /settings/pageLayouts
     * @allow get: if true
     * @deny create, update, delete, list: if false
     * @principle Public read, restricted write.
     */
    match /settings/pageLayouts {
      allow get: if true;
      allow create, update, delete, list: if false;
    }

    /**
     * @description Allows any user to read site settings, but restricts creation and modification.
     * @path /settings/site
     * @allow get: if true
     * @deny create, update, delete, list: if false
     * @principle Public read, restricted write.
     */
    match /settings/site {
      allow get: if true;
      allow create, update, delete, list: if false;
    }

    /**
     * @description Allows authenticated users to create user activity logs, but restricts modification and deletion.
     * @path /user_activity/{activityId}
     *  @allow create: if request.auth.uid != null
     *  @deny get, list, update, delete: if false
     * @principle Authenticated users can create activity logs.
     */
    match /user_activity/{activityId} {
      allow create: if isSignedIn();
      allow get, list, update, delete: if false;
    }

    /**
     * @description Allows any user to read region information, but restricts creation and modification.
     * @path /regions/{regionId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /regions/{regionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to create user maps, but restricts modification and deletion.
     * @path /user_maps/{userMapId}
     * @allow create: if isSignedIn()
     * @deny get, list, update, delete: if false
     * @principle Authenticated users can create maps.
     */
    match /user_maps/{userMapId} {
      allow create: if isSignedIn();
      allow get, list, update, delete: if false;
    }

    /**
     * @description Allows any user to read ad information, but restricts creation and modification.
     * @path /ads/{adId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /ads/{adId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any user to read news articles, but restricts creation and modification.
     * @path /news/{newsId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /news/{newsId} {
      allow get, list: if true;
      allow create, update, delete: if false;

        /**
         * @description Allows any user to read comments on news articles, but restricts creation and modification.
         * @path /news/{newsId}/comments/{commentId}
         * @allow get, list: if true
         * @allow create: if isSignedIn()
         * @deny update, delete: if false
         * @principle Public read, authenticated create, restricted write.
         */
        match /comments/{commentId} {
            allow get, list: if true;
            allow create: if isSignedIn();
            allow update, delete: if false;
        }
    }

    /**
     * @description Allows anyone to read reported comments, but restricts creation and modification.
     * @path /reports/{reportId}
     * @allow get, list: if true
     * @deny create, update, delete: if false
     * @principle Public read, restricted write.
     */
    match /reports/{reportId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    function isSignedIn() {
        return request.auth != null;
    }
  }
}