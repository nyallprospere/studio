/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict authorization model.
 *
 * Core Philosophy:
 * All write operations are restricted to authenticated users.
 * Read operations on top-level collections are generally public.
 * User-specific data is secured using an ownership model, where a user can only access their own data.
 *
 * Data Structure:
 * The Firestore database is organized into top-level collections like 'elections', 'parties', and 'news'.
 * Subcollections, such as 'comments' under 'news', inherit the security context of their parent documents.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed to protect privacy.
 * - Ambiguous relationships default to owner-only access.
 * - The 'settings' collections (site and page layouts) are only writable by authenticated users, and readable by all.
 *
 * Denormalization for Authorization:
 * To avoid costly `get()` calls in the rules, any data needed for authorization (e.g., owner ID) should be denormalized
 * directly onto the documents being secured.  For example, an 'ElectionResult' document could include a denormalized
 * 'electionId' field to simplify ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the requesting user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requesting user is the owner of the document based on the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of an existing document.
     * @principle Robustness for State-Changing Operations: Ensures the document exists before allowing updates or deletes.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the mailing_list_subscribers collection.
     * @path /mailing_list_subscribers/{subscriberId}
     * @allow (create) - Any signed-in user can subscribe to the mailing list.
     * @deny (read, write) - Only signed in users can create documents.
     * @principle Verified Identity: Requires the user to be authenticated.
     */
    match /mailing_list_subscribers/{subscriberId} {
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Rules for the parties collection.
     * @path /parties/{partyId}
     * @allow (get, list) - Anyone can read the list of parties.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /parties/{partyId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the party_logos collection.
     * @path /party_logos/{partyLogoId}
     * @allow (get, list) - Anyone can read the list of party logos.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /party_logos/{partyLogoId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the events collection.
     * @path /events/{eventId}
     * @allow (get, list) - Anyone can read the list of events.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the candidates collection.
     * @path /candidates/{candidateId}
     * @allow (get, list) - Anyone can read the list of candidates.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /candidates/{candidateId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the archived_candidates collection.
     * @path /archived_candidates/{archivedCandidateId}
     * @allow (get, list) - Anyone can read the list of archived candidates.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /archived_candidates/{archivedCandidateId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the elections collection.
     * @path /elections/{electionId}
     * @allow (get, list) - Anyone can read the list of elections.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /elections/{electionId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the polling_data collection.
     * @path /polling_data/{pollingDataId}
     * @allow (get, list) - Anyone can read the list of polling data.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /polling_data/{pollingDataId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the constituencies collection.
     * @path /constituencies/{constituencyId}
     * @allow (get, list) - Anyone can read the list of constituencies.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /constituencies/{constituencyId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the election_results collection.
     * @path /election_results/{electionResultId}
     * @allow (get, list) - Anyone can read the election results.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /election_results/{electionResultId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the page layouts settings document.
     * @path /settings/pageLayouts
     * @allow (get) - Anyone can read the page layouts.
     * @deny (create, update, delete) - Only signed in users can write, for now.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /settings/pageLayouts {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the site settings document.
     * @path /settings/site
     * @allow (get) - Anyone can read the site settings.
     * @deny (create, update, delete) - Only signed in users can write, for now.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /settings/site {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the user_activity collection.
     * @path /user_activity/{activityId}
     * @allow (create) - All users can create activity logs.
     * @deny (get, list, update, delete) - Only signed in users can create documents.
     * @principle Verified Identity: Requires the user to be authenticated.
     */
    match /user_activity/{activityId} {
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Rules for the regions collection.
     * @path /regions/{regionId}
     * @allow (get, list) - Anyone can read the list of regions.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /regions/{regionId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }
    
     /**
     * @description Rules for the user_maps collection.
     * @path /user_maps/{userMapId}
     * @allow (get, list) - Anyone can read the list of user maps.
     * @deny (create, update, delete) - Only signed in users can create documents.
     */
     match /user_maps/{userMapId} {
        allow get, list: if true;
        allow create, update, delete: if isSignedIn();
    }

     /**
     * @description Rules for the ads collection.
     * @path /ads/{adId}
     * @allow (get, list) - Anyone can read the list of ads.
     * @deny (create, update, delete) - Only signed in users can create documents.
     */
    match /ads/{adId} {
        allow get, list: if true;
        allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rules for the news articles collection.
     * @path /news/{newsId}
     * @allow (get, list) - Anyone can read the news articles.
     * @deny (create, update, delete) - No unauthenticated creating, updating or deleting.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting writes.
     */
    match /news/{newsId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();

          /**
           * @description Rules for the comments subcollection under news articles.
           * @path /news/{newsId}/comments/{commentId}
           */
          match /comments/{commentId} {
              allow get, list: if true;
              allow create, update, delete: if isSignedIn();
          }
    }

     /**
      * @description Rules for the reports collection.
      * @path /reports/{reportId}
      * @allow (create) - Any signed-in user can create a report.
      * @deny (get, list, update, delete) - Only signed in users can create documents.
      * @principle Verified Identity: Requires the user to be authenticated.
      */
    match /reports/{reportId} {
        allow get, list: if false;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }
  }
}