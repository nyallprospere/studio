/**
 * @fileOverview Firestore Security Rules for the political-website project.
 *
 * Core Philosophy:
 * This ruleset prioritizes strong authorization and allows for rapid prototyping.
 * It enforces access control based on user authentication and, where applicable,
 * document ownership. Schema validation is relaxed to enable flexible data structures
 * during early development.
 *
 * Data Structure:
 * The Firestore database consists of several top-level collections, including
 * `mailing_list_subscribers`, `parties`, `events`, `candidates`, `elections`,
 * `polling_data`, `constituencies`, `election_results`, `user_activity`, `regions`,
 * `user_maps`, `ads`, `news`, and `reports`.
 * The `/settings` document contains sub-documents `site` and `pageLayouts` for global site settings and page layouts, respectively.
 * Comments are stored as subcollections under news articles: `/news/{newsId}/comments/{commentId}`.
 *
 * Key Security Decisions:
 * - Public Read Access: Certain collections (`parties`, `events`, `candidates`, `elections`, `polling_data`, `constituencies`, `news`)
 *   are configured for public read access to facilitate open data consumption. However, write access to these collections is restricted.
 * - User Activity Logging:  Writing to the `user_activity` collection is allowed for any signed-in user.
 * - No User Listing: Listing all users is disallowed to protect user privacy.
 * - Reports Access: all signed in users can access the reports collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rule for the root of the database.  Does nothing, but is required.
     * @path /
     * @allow (get) Authenticated user can get the root.
     * @deny (create) No one can create at the root.
     * @principle Placeholder, but required for valid syntax.
     */
    match /{document=**} {
      allow read, write: if false;
    }

    /**
     * @description Allows anyone to subscribe to the mailing list.
     * @path /mailing_list_subscribers/{subscriberId}
     * @allow (create) Any user can create a subscriber document with a valid email and subscribe date.
     * @deny (update) No one can update a subscriber document.
     * @principle Open subscription, no updates.
     */
    match /mailing_list_subscribers/{subscriberId} {
      allow get, list: if false;
      allow create: if true;
      allow update, delete: if false;
    }

    /**
     * @description Allows public read access to political party information. Write access is not allowed.
     * @path /parties/{partyId}
     * @allow (get, list) Any user can retrieve party information.
     * @deny (create, update, delete) No one can modify party information.
     * @principle Public read, no writes.
     */
    match /parties/{partyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

     /**
      * @description Allows public read access to party logos. Write access is not allowed.
      * @path /party_logos/{partyLogoId}
      * @allow (get, list) Any user can retrieve party logos.
      * @deny (create, update, delete) No one can modify party logos.
      * @principle Public read, no writes.
      */
    match /party_logos/{partyLogoId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to political event information. Write access is not allowed.
     * @path /events/{eventId}
     * @allow (get, list) Any user can retrieve event information.
     * @deny (create, update, delete) No one can modify event information.
     * @principle Public read, no writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to candidate information. Write access is not allowed.
     * @path /candidates/{candidateId}
     * @allow (get, list) Any user can retrieve candidate information.
     * @deny (create, update, delete) No one can modify candidate information.
     * @principle Public read, no writes.
     */
    match /candidates/{candidateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to archived candidate information. Write access is not allowed.
     * @path /archived_candidates/{archivedCandidateId}
     * @allow (get, list) Any user can retrieve archived candidate information.
     * @deny (create, update, delete) No one can modify archived candidate information.
     * @principle Public read, no writes.
     */
    match /archived_candidates/{archivedCandidateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to election information. Write access is not allowed.
     * @path /elections/{electionId}
     * @allow (get, list) Any user can retrieve election information.
     * @deny (create, update, delete) No one can modify election information.
     * @principle Public read, no writes.
     */
    match /elections/{electionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to polling data. Write access is not allowed.
     * @path /polling_data/{pollingDataId}
     * @allow (get, list) Any user can retrieve polling data.
     * @deny (create, update, delete) No one can modify polling data.
     * @principle Public read, no writes.
     */
    match /polling_data/{pollingDataId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to constituency information. Write access is not allowed.
     * @path /constituencies/{constituencyId}
     * @allow (get, list) Any user can retrieve constituency information.
     * @deny (create, update, delete) No one can modify constituency information.
     * @principle Public read, no writes.
     */
    match /constituencies/{constituencyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to election results. Write access is not allowed.
     * @path /election_results/{electionResultId}
     * @allow (get, list) Any user can retrieve election results.
     * @deny (create, update, delete) No one can modify election results.
     * @principle Public read, no writes.
     */
    match /election_results/{electionResultId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to page layouts for authenticated users.
     * @path /settings/pageLayouts
     * @allow (get) Any authenticated user can retrieve the page layouts.
     * @allow (create, update, delete) No one can modify page layouts.
     * @principle Authentication required for access, no writes allowed.
     */
    match /settings/pageLayouts {
      allow get: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read access to site settings for authenticated users.
     * @path /settings/site
     * @allow (get) Any authenticated user can retrieve the site settings.
     * @deny (create, update, delete) No one can modify site settings.
     * @principle Authentication required for access, no writes allowed.
     */
    match /settings/site {
      allow get: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any signed-in user to log their activity.
     * @path /user_activity/{activityId}
     * @allow (create) Any signed-in user can create an activity log.
     * @deny (get, list, update, delete) Only creation is allowed.
     * @principle Logging for signed-in users.
     */
    match /user_activity/{activityId} {
      allow get, list, update, delete: if false;
      allow create: if isSignedIn();
    }

    /**
     * @description Allows public read access to region information. Write access is not allowed.
     * @path /regions/{regionId}
     * @allow (get, list) Any user can retrieve region information.
     * @deny (create, update, delete) No one can modify region information.
     * @principle Public read, no writes.
     */
    match /regions/{regionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to user-created maps for authenticated users.
     * @path /user_maps/{userMapId}
     * @allow (get, create, update, delete) Authenticated users can perform CRUD operations on user maps.
     * @principle Authentication required for access.
     */
    match /user_maps/{userMapId} {
        allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows read and write access to ads for authenticated users.
     * @path /ads/{adId}
     * @allow (get, create, update, delete) Authenticated users can perform CRUD operations on ads.
     * @principle Authentication required for access.
     */
    match /ads/{adId} {
        allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows public read access to news articles. Write access is not allowed.
     * @path /news/{newsId}
     * @allow (get, list) Any user can retrieve news articles.
     * @deny (create, update, delete) No one can modify news articles.
     * @principle Public read, no writes.
     */
    match /news/{newsId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to news article comments for authenticated users.
     * @path /news/{newsId}/comments/{commentId}
     * @allow (get, list, create, update, delete) Authenticated users can perform CRUD operations on news article comments.
     * @principle Authentication required for access.
     */
    match /news/{newsId}/comments/{commentId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows any logged in user to read/write to reports.
     * @path /reports/{reportId}
     * @allow (get, list) Any authenticated user can access the reports.
     * @deny (create, update, delete) No one can modify reports.
     */
    match /reports/{reportId} {
        allow get, list, create, update, delete: if isSignedIn();
    }


  }

  /**
   * @description Checks if the user is signed in.
   * @returns {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }
}