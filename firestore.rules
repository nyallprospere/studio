/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset prioritizes strong authorization. It defaults to a restrictive
 * access model, requiring explicit rules to permit read or write operations.
 *
 * Data Structure:
 * The Firestore database consists of several top-level collections,
 * including 'mailing_list_subscribers', 'parties', 'events', 'candidates',
 * 'elections', 'polling_data', 'constituencies', 'election_results', 'user_activity', 'regions', 'user_maps', 'ads',
 * and 'news'.  Some collections have subcollections (e.g., 'news/{newsId}/comments/{commentId}').
 * The 'settings' collection contains singleton documents ('pageLayouts', 'site').
 *
 * Key Security Decisions:
 * - User listing is generally disallowed unless explicitly required and secured.
 * - Read-only collections are explicitly marked as such.
 * - Ambiguous relationships default to owner-only access.
 *
 * Access Control Patterns:
 * - Results in `election_results` can be managed by any logged-in user.
 *
 * Denormalization for Authorization:
 * None needed in this version.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Restricts access to mailing list subscriber data. Only allow writes
     * @path /mailing_list_subscribers/{subscriberId}
     * @allow (create) A user submitting their email to the mailing list.
     * @deny (get) Any user attempting to read a subscriber's data.
     * @deny (update) Any user attempting to modify a subscriber's data.
     * @deny (delete) Any user attempting to delete a subscriber's data.
     * @principle Data is considered private and not accessible to other users.
     */
    match /mailing_list_subscribers/{subscriberId} {
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Restricts access to political party data.
     * @path /parties/{partyId}
     * @allow (get, list) Anyone can view the list of parties.
     * @deny (create, update, delete) No one can create, update, or delete parties.
     * @principle Data is considered public read-only.
     */
    match /parties/{partyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to party logo data.
     * @path /party_logos/{partyLogoId}
     * @allow (get, list) Anyone can view the list of party logos.
     * @deny (create, update, delete) No one can create, update, or delete party logos.
     * @principle Data is considered public read-only.
     */
    match /party_logos/{partyLogoId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to event data.
     * @path /events/{eventId}
     * @allow (get, list) Anyone can view the list of events.
     * @deny (create, update, delete) No one can create, update, or delete events.
     * @principle Data is considered public read-only.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to candidate data.
     * @path /candidates/{candidateId}
     * @allow (get, list) Anyone can view the list of candidates.
     * @deny (create, update, delete) No one can create, update, or delete candidates.
     * @principle Data is considered public read-only.
     */
    match /candidates/{candidateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to archived candidate data.
     * @path /archived_candidates/{archivedCandidateId}
     * @allow (get, list) Anyone can view the list of archived candidates.
     * @deny (create, update, delete) No one can create, update, or delete archived candidates.
     * @principle Data is considered public read-only.
     */
    match /archived_candidates/{archivedCandidateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to election data.
     * @path /elections/{electionId}
     * @allow (get, list) Anyone can view the list of elections.
     * @deny (create, update, delete) No one can create, update, or delete elections.
     * @principle Data is considered public read-only.
     */
    match /elections/{electionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to polling data.
     * @path /polling_data/{pollingDataId}
     * @allow (get, list) Anyone can view the list of polling data.
     * @deny (create, update, delete) No one can create, update, or delete polling data.
     * @principle Data is considered public read-only.
     */
    match /polling_data/{pollingDataId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to constituency data.
     * @path /constituencies/{constituencyId}
     * @allow (get, list) Anyone can view the list of constituencies.
     * @deny (create, update, delete) No one can create, update, or delete constituencies.
     * @principle Data is considered public read-only.
     */
    match /constituencies/{constituencyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows any logged-in user to manage election results.
     * @path /election_results/{electionResultId}
     * @allow (get, list) Anyone can view the list of election results.
     * @allow (create, update, delete) Any logged-in user can create, update, or delete election results.
     * @principle Logged-in users can manage election results.
     */
    match /election_results/{electionResultId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Restricts access to page layout settings.
     * @path /settings/pageLayouts
     * @allow (get) Anyone can read the page layouts.
     * @deny (list) Listing documents in the /settings/ collection is not allowed.
     * @deny (create, update, delete) No one can create, update, or delete the page layouts.
     * @principle Data is considered public read-only.
     */
    match /settings/pageLayouts {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to site settings.
     * @path /settings/site
     * @allow (get) Anyone can read the site settings.
     * @deny (list) Listing documents in the /settings/ collection is not allowed.
     * @deny (create, update, delete) No one can create, update, or delete the site settings.
     * @principle Data is considered public read-only.
     */
    match /settings/site {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to user activity data.
     * @path /user_activity/{activityId}
     * @allow (create) Any signed-in user can create activity logs.
     * @deny (get, list, update, delete) No one can read, list, update, or delete activity logs.
     * @principle Data is write-only; intended for logging, not retrieval.
     */
    match /user_activity/{activityId} {
      allow get, list, update, delete: if false;
      allow create: if isSignedIn();
    }

    /**
     * @description Restricts access to region data.
     * @path /regions/{regionId}
     * @allow (get, list) Anyone can view the list of regions.
     * @deny (create, update, delete) No one can create, update, or delete regions.
     * @principle Data is considered public read-only.
     */
    match /regions/{regionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to user map data.
     * @path /user_maps/{userMapId}
     * @allow (create) Any signed-in user can create a map.
     * @deny (get, list, update, delete) No one can read, list, update, or delete a map.
     * @principle Data is write-only; intended for predictions, not retrieval.
     */
    match /user_maps/{userMapId} {
      allow get, list, update, delete: if false;
      allow create: if isSignedIn();
    }

    /**
     * @description Restricts access to ad data.
     * @path /ads/{adId}
     * @allow (get, list) Anyone can view the list of ads.
     * @deny (create, update, delete) No one can create, update, or delete ads.
     * @principle Data is considered public read-only.
     */
    match /ads/{adId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to news article data.
     * @path /news/{newsId}
     * @allow (get, list) Anyone can view the list of news articles.
     * @deny (create, update, delete) No one can create, update, or delete news articles.
     * @principle Data is considered public read-only.
     */
    match /news/{newsId} {
      allow get, list: if true;
      allow create, update, delete: if false;

      /**
       * @description Restricts access to news article comments.
       * @path /news/{newsId}/comments/{commentId}
       * @allow (get, list) Anyone can view the list of comments.
       * @allow (create) Any signed-in user can create a comment.
       * @deny (update, delete) No one can update or delete comments.
       * @principle Comments are publicly readable and only created by signed-in users.
       */
      match /comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
      }
    }

        /**
         * @description Restricts access to reported comment data.
         * @path /reports/{reportId}
         * @allow (create) Any signed-in user can create a report.
         * @deny (get, list, update, delete) No one can read, list, update, or delete reports.
         * @principle Reports are only created by signed-in users for moderation.
         */
        match /reports/{reportId} {
          allow get, list, update, delete: if false;
          allow create: if isSignedIn();
        }

  }
}

/**
 * @description Checks if the user is signed in.
 * @return {boolean} True if the user is signed in, false otherwise.
 * @principle Authentication is required for certain operations.
 */
function isSignedIn() {
  return request.auth != null;
}