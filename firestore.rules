/**
 * @fileoverview Firestore Security Rules for Revolucianize project.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on a combination of public read access for some collections (e.g., constituencies, elections) and owner-only write access enforced via the `request.auth.uid`.  It assumes a prototyping phase where strict data validation is relaxed in favor of rapid iteration, but authorization is paramount.
 *
 * Data Structure:
 * The Firestore data is organized into top-level collections such as `parties`, `candidates`, `elections`, `constituencies`, `news`, and `ads`.  Some collections have subcollections (e.g. `news/{newsId}/comments/{commentId}`). The `settings` document contains single documents for site-wide settings and page layouts.
 *
 * Key Security Decisions:
 * - Public Read Access:  `constituencies`, `elections`, `parties`, `news`, and `ads` collections are publicly readable.
 * - Owner-Only Writes:  Write operations (create, update, delete) are restricted to authenticated users, with ownership validated against a designated `authorId` or similar field within the document.
 * - User-Specific Data: The `user_activity` and `user_maps` collections are secured to only allow access to the authenticated user's own documents.
 * - Reports Collection: The `/reports` collection is for admin/moderator usage and is NOT secured in this initial prototype phase. Access should be secured later.
 * - Denormalization: To simplify security rules and improve performance, the rules assume that data required for authorization decisions (e.g., ownership) is denormalized directly onto the documents being secured.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read mailing list subscribers. All writes are denied.
     * @path /mailing_list_subscribers/{subscriberId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for mailing list reads with no write operations allowed.
     */
    match /mailing_list_subscribers/{subscriberId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read political parties. All writes are denied.
     * @path /parties/{partyId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for parties reads with no write operations allowed.
     */
    match /parties/{partyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read election-specific party logos. All writes are denied.
     * @path /party_logos/{partyLogoId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for party logos reads with no write operations allowed.
     */
    match /party_logos/{partyLogoId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read political events. All writes are denied.
     * @path /events/{eventId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for events reads with no write operations allowed.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read candidates. All writes are denied.
     * @path /candidates/{candidateId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for candidates reads with no write operations allowed.
     */
    match /candidates/{candidateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read archived candidates. All writes are denied.
     * @path /archived_candidates/{archivedCandidateId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for archived candidates reads with no write operations allowed.
     */
    match /archived_candidates/{archivedCandidateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read elections. All writes are denied.
     * @path /elections/{electionId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for elections reads with no write operations allowed.
     */
    match /elections/{electionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read polling data. All writes are denied.
     * @path /polling_data/{pollingDataId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for polling data reads with no write operations allowed.
     */
    match /polling_data/{pollingDataId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read constituencies. All writes are denied.
     * @path /constituencies/{constituencyId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for constituencies reads with no write operations allowed.
     */
    match /constituencies/{constituencyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read election results. All writes are denied.
     * @path /election_results/{electionResultId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for election results reads with no write operations allowed.
     */
    match /election_results/{electionResultId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read page layouts. All writes are denied.
     * @path /settings/pageLayouts
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for page layouts reads with no write operations allowed.
     */
    match /settings/pageLayouts {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read site settings. All writes are denied.
     * @path /settings/site
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for site settings reads with no write operations allowed.
     */
    match /settings/site {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows the owner to read, create, update and delete their own activity logs.
     * @path /user_activity/{activityId}
     * @allow get, list: if isOwner(request.auth.uid);
     * @allow create: if request.auth.uid != null;
     * @allow update: if isExistingOwner(request.auth.uid);
     * @allow delete: if isExistingOwner(request.auth.uid);
     * @principle Enforces document ownership for user activity logs.
     */
    match /user_activity/{activityId} {
      allow get, list: if isOwner(request.auth.uid);
      allow create: if request.auth.uid != null;
      allow update: if isExistingOwner(request.auth.uid);
      allow delete: if isExistingOwner(request.auth.uid);
    }

    /**
     * @description Allows anyone to read regions. All writes are denied.
     * @path /regions/{regionId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for regions reads with no write operations allowed.
     */
    match /regions/{regionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows the owner to read, create, update, and delete their own user maps.
     * @path /user_maps/{userMapId}
     * @allow get, list: if isOwner(request.auth.uid);
     * @allow create: if request.auth.uid != null;
     * @allow update: if isExistingOwner(request.auth.uid);
     * @allow delete: if isExistingOwner(request.auth.uid);
     * @principle Enforces document ownership for user maps.
     */
    match /user_maps/{userMapId} {
      allow get, list: if isOwner(request.auth.uid);
      allow create: if request.auth.uid != null;
      allow update: if isExistingOwner(request.auth.uid);
      allow delete: if isExistingOwner(request.auth.uid);
    }

    /**
     * @description Allows anyone to read ads. All writes are denied.
     * @path /ads/{adId}
     * @allow get, list: if true;
     * @deny create, update, delete: if false;
     * @principle Open access for ads reads with no write operations allowed.
     */
    match /ads/{adId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read news articles. Writes should be restricted to authorized users in production.
     * @path /news/{newsId}
     * @allow get, list: if true;
     * @allow create: if request.auth.uid != null; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow update: if request.auth.uid != null && resource != null; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if request.auth.uid != null && resource != null; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Open access for news reads with owner-only writes (currently allows writes for all signed in users, need owner field to refine).
     */
    match /news/{newsId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if request.auth.uid != null && resource != null; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if request.auth.uid != null && resource != null; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows anyone to read news article comments.  Writes should be restricted to authorized users in production, owner only reads for owner, and public otherwise.
     * @path /news/{newsId}/comments/{commentId}
     * @allow get, list: if true;
     * @allow create: if request.auth.uid != null;
     * @allow update: if request.auth.uid != null && resource != null; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if request.auth.uid != null && resource != null; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Open access for news comments reads with owner-only writes (currently allows writes for all signed in users, need owner field to refine).
     */
    match /news/{newsId}/comments/{commentId} {
        allow get, list: if true;
        allow create: if request.auth.uid != null;
        allow update: if request.auth.uid != null && resource != null;
        allow delete: if request.auth.uid != null && resource != null;
    }

     /**
      * @description Allows anyone to read reports. Writes should be restricted to authorized users in production.
      * @path /reports/{reportId}
      * @allow get, list: if true; // TODO: Add authentication to ensure only admins or moderators can access reports.
      * @allow create: if request.auth.uid != null;
      * @allow update: if request.auth.uid != null && resource != null;
      * @allow delete: if request.auth.uid != null && resource != null;
      */
    match /reports/{reportId} {
        allow get, list: if request.auth.uid != null; // TODO: Add authentication to ensure only admins or moderators can access reports.
        allow create: if request.auth.uid != null;
        allow update: if request.auth.uid != null && resource != null;
        allow delete: if request.auth.uid != null && resource != null;
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}