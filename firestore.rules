/**
 * @fileoverview Firestore Security Rules for the St. Lucia Elections Hub application.
 *
 * Core Philosophy:
 * This ruleset prioritizes Authorization Independence by avoiding hierarchical
 * authorization dependencies and denormalizing data where necessary. It enforces
 * a public-read, owner-write access pattern for most top-level collections.
 *
 * Data Structure:
 * The database consists of several top-level collections: `parties`,
 * `candidates`, `elections`, `polling_data`, `constituencies`, and
 * `election_results`. Each collection stores data related to its namesake entity.
 *
 * Key Security Decisions:
 * - All collections are publicly readable via `get` and `list`.
 * - Write access (create, update, delete) is restricted to authenticated users.
 * - The `settings/site` document is implicitly denied read access as there is no rule provided for it.
 * - All write operations require the user to be authenticated.
 *
 * Denormalization for Authorization:
 *  None is required as the current data model is flat.
 *  If the application required more complex access control (e.g., roles within
 *  an election), data would be denormalized directly onto the Election document.
 *
 * Structural Segregation:
 *  Data is segregated into separate collections based on entity type.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /****************** Parties Collection Rules ******************/

    /**
     * @description Grants read access to all and restricts write access to authenticated users for the parties collection.
     * @path /parties/{partyId}
     * @allow (get, list): Any user can read party data.
     * @allow (create): Any authenticated user can create a party.
     * @deny (update, delete): Only authenticated users can modify parties.
     * @principle Public read, authenticated write.
     */
    match /parties/{partyId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /****************** Candidates Collection Rules ******************/

    /**
     * @description Grants read access to all and restricts write access to authenticated users for the candidates collection.
     * @path /candidates/{candidateId}
     * @allow (get, list): Any user can read candidate data.
     * @allow (create): Any authenticated user can create a candidate.
     * @deny (update, delete): Only authenticated users can modify candidates.
     * @principle Public read, authenticated write.
     */
    match /candidates/{candidateId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /****************** Elections Collection Rules ******************/

    /**
     * @description Grants read access to all and restricts write access to authenticated users for the elections collection.
     * @path /elections/{electionId}
     * @allow (get, list): Any user can read election data.
     * @allow (create): Any authenticated user can create an election.
     * @deny (update, delete): Only authenticated users can modify elections.
     * @principle Public read, authenticated write.
     */
    match /elections/{electionId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /****************** Polling Data Collection Rules ******************/

    /**
     * @description Grants read access to all and restricts write access to authenticated users for the polling_data collection.
     * @path /polling_data/{pollingDataId}
     * @allow (get, list): Any user can read polling data.
     * @allow (create): Any authenticated user can create polling data.
     * @deny (update, delete): Only authenticated users can modify polling data.
     * @principle Public read, authenticated write.
     */
    match /polling_data/{pollingDataId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /****************** Constituencies Collection Rules ******************/

    /**
     * @description Grants read access to all and restricts write access to authenticated users for the constituencies collection.
     * @path /constituencies/{constituencyId}
     * @allow (get, list): Any user can read constituency data.
     * @allow (create): Any authenticated user can create a constituency.
     * @deny (update, delete): Only authenticated users can modify constituencies.
     * @principle Public read, authenticated write.
     */
    match /constituencies/{constituencyId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /****************** Election Results Collection Rules ******************/

    /**
     * @description Grants read access to all and restricts write access to authenticated users for the election_results collection.
     * @path /election_results/{electionResultId}
     * @allow (get, list): Any user can read election results data.
     * @allow (create): Any authenticated user can create election results data.
     * @deny (update, delete): Only authenticated users can modify election results data.
     * @principle Public read, authenticated write.
     */
    match /election_results/{electionResultId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /****************** Settings/Site Document Rules ******************/
    /**
     * @description  Denies read access to the /settings/site document, as there are no specific read permissions configured for it.
     * @path /settings/site
     * @deny (get):  Any user is denied read access to the /settings/site document.
     * @principle Implicitly deny read access to undefined paths.
     */
    match /settings/site {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

  }
}