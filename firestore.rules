/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a public-read, restricted-write model for most data,
 *  with an emphasis on allowing only authenticated users to create, update, or delete content.
 *  It prioritizes a flexible data structure, foregoing strict schema validation for rapid prototyping.
 *
 * @dataStructure
 *  - Top-level collections store core application data (parties, candidates, events, etc.).
 *  - `/settings` collection contains singleton documents for global configuration.
 *  - No user-specific data is stored under `/users/{userId}` paths.
 *
 * @keySecurityDecisions
 *  - Mailing list subscribers can be listed by anyone.
 *  - All other top-level collections are publicly readable.
 *  - Writes to all collections are restricted to authenticated users.
 *  - No user listing is allowed.
 *
 * @denormalizationForAuthorization
 *  - The ruleset assumes that documents in public-read collections do NOT contain ownership
 *    fields. If ownership is required, the schema MUST be updated to include `ownerId` or `authorId`
 *    and the rules MUST be adjusted accordingly.
 *
 * @structuralSegregation
 *  - There is no segregation of public and private content. All collections are treated as public for reads
 *    but secured against unauthorized writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Anyone can read and list the emails of mailing list subscribers.
     * @path /mailing_list_subscribers/{subscriberId}
     * @allow (get, list) Unauthenticated user can read a mailing list subscriber
     * @deny (create, update, delete) Unauthenticated user cannot modify mailing list subscribers
     * @principle Public read access for mailing list.
     */
    match /mailing_list_subscribers/{subscriberId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores information about political parties. The `partyId` is used as the document ID.
     * @path /parties/{partyId}
     * @allow (get, list) Unauthenticated user can read party information
     * @allow (create, update, delete) Authenticated user can create/update/delete party information
     * @deny (create, update, delete) Unauthenticated user cannot modify party information
     * @principle Public read, authenticated write for party information.
     */
    match /parties/{partyId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores election-specific logos for parties.
     * @path /party_logos/{partyLogoId}
     * @allow (get, list) Unauthenticated user can read party logos
     * @allow (create, update, delete) Authenticated user can create/update/delete party logos
     * @deny (create, update, delete) Unauthenticated user cannot modify party logos
     * @principle Public read, authenticated write for party logos.
     */
    match /party_logos/{partyLogoId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores information about political events. The `eventId` is used as the document ID.
     * @path /events/{eventId}
     * @allow (get, list) Unauthenticated user can read event information
     * @allow (create, update, delete) Authenticated user can create/update/delete event information
     * @deny (create, update, delete) Unauthenticated user cannot modify event information
     * @principle Public read, authenticated write for event information.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores information about candidates. The `candidateId` is used as the document ID.
     * @path /candidates/{candidateId}
     * @allow (get, list) Unauthenticated user can read candidate information
     * @allow (create, update, delete) Authenticated user can create/update/delete candidate information
     * @deny (create, update, delete) Unauthenticated user cannot modify candidate information
     * @principle Public read, authenticated write for candidate information.
     */
    match /candidates/{candidateId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores archived candidate data from previous election cycles. The `archivedCandidateId` is used as the document ID.
     * @path /archived_candidates/{archivedCandidateId}
     * @allow (get, list) Unauthenticated user can read archived candidate information
     * @allow (create, update, delete) Authenticated user can create/update/delete archived candidate information
     * @deny (create, update, delete) Unauthenticated user cannot modify archived candidate information
     * @principle Public read, authenticated write for archived candidate information.
     */
    match /archived_candidates/{archivedCandidateId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores information about elections. The `electionId` is used as the document ID.
     * @path /elections/{electionId}
     * @allow (get, list) Unauthenticated user can read election information
     * @allow (create, update, delete) Authenticated user can create/update/delete election information
     * @deny (create, update, delete) Unauthenticated user cannot modify election information
     * @principle Public read, authenticated write for election information.
     */
    match /elections/{electionId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores polling data for elections. The `pollingDataId` is used as the document ID.
     * @path /polling_data/{pollingDataId}
     * @allow (get, list) Unauthenticated user can read polling data
     * @allow (create, update, delete) Authenticated user can create/update/delete polling data
     * @deny (create, update, delete) Unauthenticated user cannot modify polling data
     * @principle Public read, authenticated write for polling data.
     */
    match /polling_data/{pollingDataId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores information about constituencies. The `constituencyId` is used as the document ID.
     * @path /constituencies/{constituencyId}
     * @allow (get, list) Unauthenticated user can read constituency information
     * @allow (create, update, delete) Authenticated user can create/update/delete constituency information
     * @deny (create, update, delete) Unauthenticated user cannot modify constituency information
     * @principle Public read, authenticated write for constituency information.
     */
    match /constituencies/{constituencyId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores election results. The `electionResultId` is used as the document ID.
     * @path /election_results/{electionResultId}
     * @allow (get, list) Unauthenticated user can read election results
     * @allow (create, update, delete) Authenticated user can create/update/delete election results
     * @deny (create, update, delete) Unauthenticated user cannot modify election results
     * @principle Public read, authenticated write for election results.
     */
    match /election_results/{electionResultId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores user-defined layouts for various pages. This is a single document.
     * @path /settings/pageLayouts
     * @allow (get) Unauthenticated user can read page layouts
     * @allow (create, update, delete) Authenticated user can create/update/delete page layouts
     * @deny (create, update, delete) Unauthenticated user cannot modify page layouts
     * @principle Public read, authenticated write for page layouts.
     */
    match /settings/pageLayouts {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores global site settings. This is a single document.
     * @path /settings/site
     * @allow (get) Unauthenticated user can read site settings
     * @allow (create, update, delete) Authenticated user can create/update/delete site settings
     * @deny (create, update, delete) Unauthenticated user cannot modify site settings
     * @principle Public read, authenticated write for site settings.
     */
    match /settings/site {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores user activity events, such as page visits. The `activityId` is used as the document ID.
     * @path /user_activity/{activityId}
     * @allow (get, list) Unauthenticated user can read user activity
     * @allow (create) Authenticated user can create user activity
     * @deny (update, delete) User activity cannot be updated or deleted
     * @principle Public read, authenticated create, no update or delete for user activity.
     */
    match /user_activity/{activityId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Stores information about regions. The `regionId` is used as the document ID.
     * @path /regions/{regionId}
     * @allow (get, list) Unauthenticated user can read region information
     * @allow (create, update, delete) Authenticated user can create/update/delete region information
     * @deny (create, update, delete) Unauthenticated user cannot modify region information
     * @principle Public read, authenticated write for region information.
     */
    match /regions/{regionId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Stores user-created prediction maps.
     * @path /user_maps/{userMapId}
     * @allow (get, list) Unauthenticated user can read user maps
     * @allow (create, update, delete) Authenticated user can create/update/delete user maps
     * @deny (create, update, delete) Unauthenticated user cannot modify user maps
     * @principle Public read, authenticated write for user maps.
     */
    match /user_maps/{userMapId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }
}