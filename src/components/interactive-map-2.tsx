
'use client';

import { useMemo } from 'react';
import type { Constituency, ElectionResult, Election, PartyLogo } from '@/lib/types';
import { cn } from '@/lib/utils';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { ConstituencyPopoverContent } from '@/components/constituency-popover-content';

interface InteractiveMap2Props {
    constituencies: Constituency[];
    selectedConstituencyId: string | null;
    election?: Election | null;
    onConstituencyClick: (id: string) => void;
    onLeaningChange?: (id: string, leaning: string) => void;
    onPredictionChange?: (id: string, slp: number, uwp: number) => void;
    electionResults?: ElectionResult[];
    previousElectionResults?: ElectionResult[];
    partyLogos?: PartyLogo[];
    isMakeYourOwn?: boolean;
}

const politicalLeaningOptions = [
  { value: 'solid-uwp', label: 'Solid UWP', color: 'fill-yellow-500' },
  { value: 'lean-uwp', label: 'Lean UWP', color: 'fill-yellow-300' },
  { value: 'tossup', label: 'Tossup', color: 'fill-purple-500' },
  { value: 'lean-slp', label: 'Lean SLP', color: 'fill-red-400' },
  { value: 'solid-slp', label: 'Solid SLP', color: 'fill-red-700' },
];

const makeYourOwnLeaningOptions = [
  { value: 'slp', label: 'SLP', color: 'fill-red-500' },
  { value: 'uwp', label: 'UWP', color: 'fill-yellow-400' },
  { value: 'tossup', label: 'Toss Up', color: 'fill-purple-500' },
  { value: 'unselected', label: 'To be selected', color: 'fill-gray-300' },
];

const getLeaningInfo = (leaning: string | undefined, isMakeYourOwn?: boolean) => {
    const options = isMakeYourOwn ? makeYourOwnLeaningOptions : politicalLeaningOptions;
    const defaultLeaningValue = isMakeYourOwn ? 'unselected' : 'tossup';
    const defaultLeaning = options.find(o => o.value === defaultLeaningValue)!;
    const leaningInfo = options.find(o => o.value === leaning) || defaultLeaning;
    return { className: leaningInfo.color };
};

const SVGPaths: Record<string, string> = {
    "Micoud North": `M 419.00,979.00 C 417.11,972.86 413.53,972.19 408.00,969.50 403.22,967.19 386.81,962.54 384.60,960.23 383.13,958.71 382.64,955.23 381.68,953.00 380.85,951.09 379.59,949.20 379.49,947.05 379.27,942.43 384.68,941.60 388.00,940.29 391.39,938.95 405.51,930.39 407.86,927.91 413.91,921.50 413.89,909.86 417.31,906.47 419.40,904.40 428.45,901.27 432.00,899.50 432.00,899.50 452.00,889.58 452.00,889.58 452.00,889.58 459.00,888.55 459.00,888.55 469.46,886.29 479.95,884.19 490.00,880.29 493.76,878.83 498.89,876.19 502.00,873.66 507.50,869.20 509.90,864.00 518.00,865.15 521.15,865.59 522.31,866.75 525.00,868.09 539.47,875.32 539.45,880.72 547.04,886.43 553.01,890.92 566.59,893.12 574.00,893.00 580.67,892.89 580.24,891.66 585.00,891.13 587.79,890.81 591.32,891.33 593.91,890.42 593.91,890.42 599.17,887.58 599.17,887.58 600.85,886.96 611.94,885.04 614.00,885.00 627.40,884.79 625.67,887.16 637.00,891.89 637.00,891.89 650.96,896.69 650.96,896.69 658.73,899.68 654.47,900.98 665.00,901.00 665.00,901.00 675.00,901.00 675.00,901.00 681.53,901.04 695.12,904.44 699.58,909.27 701.09,910.91 701.32,912.02 702.00,914.15 700.32,913.94 696.73,913.59 695.31,914.15 690.49,916.76 694.32,922.71 697.00,925.00 697.66,930.69 703.23,930.53 708.00,930.84 714.24,931.24 714.59,929.21 719.00,928.30 722.38,927.60 726.83,928.51 730.00,927.41 730.00,927.41 737.00,923.60 737.00,923.60 739.49,922.72 752.55,922.66 754.96,923.60 757.12,924.44 757.60,925.36 759.00,927.00 755.95,927.00 747.60,926.51 745.31,928.02 742.90,929.62 743.33,932.19 741.41,934.87 739.55,937.47 731.02,943.37 740.02,944.93 740.02,944.93 743.00,944.93 743.00,944.93 742.31,948.05 738.98,954.35 740.15,956.57 741.66,959.45 746.49,958.87 749.00,957.97 749.00,957.97 764.00,949.89 764.00,949.89 764.00,949.89 776.00,948.00 776.00,948.00 776.00,948.00 776.00,953.00 776.00,953.00 768.75,955.21 766.78,963.68 762.00,968.00 762.00,968.00 764.00,970.00 764.00,970.00 754.18,969.55 750.66,967.32 741.00,973.00 741.00,973.00 734.00,971.00 734.00,971.00 734.00,971.00 737.00,975.00 737.00,975.00 737.32,976.56 741.81,989.96 744.00,985.00 751.01,984.92 749.53,982.39 757.00,986.00 757.00,986.00 751.08,992.77 751.08,992.77 751.08,992.77 743.08,997.38 743.08,997.38 743.08,997.38 744.28,1007.00 744.28,1007.00 744.28,1007.00 740.30,1015.00 740.30,1015.00 740.30,1015.00 739.00,1024.00 739.00,1024.00 749.89,1026.78 750.99,1025.77 751.00,1037.00 751.00,1037.00 745.00,1035.55 745.00,1035.55 740.22,1034.93 736.21,1038.11 738.83,1043.00 740.96,1046.97 747.43,1051.39 751.00,1057.00 740.34,1057.63 736.22,1054.77 732.00,1062.00 732.00,1062.00 738.00,1066.00 738.00,1066.00 732.77,1066.00 728.81,1066.45 724.00,1064.00 724.00,1064.00 730.00,1064.00 730.00,1064.00 730.00,1064.00 721.00,1061.74 721.00,1061.74 712.88,1061.08 706.01,1069.55 713.33,1075.89 719.44,1081.18 723.22,1076.83 730.00,1081.19 732.13,1082.56 736.37,1085.23 736.37,1088.03 736.37,1092.61 729.63,1094.70 726.00,1094.95 715.78,1095.64 714.26,1090.79 707.00,1089.78 700.11,1088.38 699.54,1093.04 689.00,1089.78 691.34,1093.50 693.05,1092.95 697.00,1093.00 697.00,1093.00 701.00,1103.00 701.00,1103.00 701.00,1103.00 698.00,1104.00 698.00,1104.00 698.00,1104.00 703.00,1105.00 703.00,1105.00 703.00,1105.00 698.00,1105.00 698.00,1105.00 698.00,1105.00 701.00,1108.00 701.00,1108.00 701.00,1108.00 704.41,1115.00 704.41,1115.00 705.40,1117.87 704.51,1121.44 706.60,1123.36 710.30,1126.78 718.32,1118.83 719.00,1117.00 719.00,1117.00 728.00,1119.62 728.00,1119.62 728.00,1119.62 732.00,1121.71 732.00,1121.71 733.78,1122.52 741.61,1124.53 737.38,1127.98 735.64,1129.41 729.37,1128.99 727.00,1129.00 721.96,1129.02 712.86,1130.79 709.91,1135.30 708.89,1136.87 709.06,1138.26 709.00,1140.00 709.00,1140.00 706.00,1141.00 706.00,1141.00 706.00,1141.00 709.00,1142.00 709.00,1142.00 707.58,1142.24 705.40,1142.71 704.00,1142.51 699.37,1141.84 692.12,1132.70 688.00,1129.45 688.00,1129.45 675.00,1118.26 675.00,1118.26 675.00,1118.26 668.00,1112.87 668.00,1112.87 668.00,1112.87 639.00,1084.00 639.00,1084.00 635.84,1080.85 632.40,1076.83 628.00,1075.57 628.00,1075.57 617.00,1074.85 617.00,1074.85 612.06,1073.49 609.45,1071.35 605.00,1074.85 605.00,1074.85 602.00,1074.85 602.00,1074.85 599.06,1071.43 596.09,1073.89 592.00,1072.00 584.22,1068.39 576.36,1056.46 567.00,1060.00 567.00,1060.00 565.00,1058.00 565.00,1058.00 562.34,1060.10 559.81,1058.36 558.00,1056.00 558.00,1056.00 552.00,1055.00 552.00,1055.00 549.29,1049.28 546.50,1046.34 540.00,1048.00 540.00,1048.00 535.00,1045.00 535.00,1045.00 535.00,1045.00 535.00,1043.00 535.00,1043.00 535.00,1043.00 528.00,1041.00 528.00,1041.00 524.40,1033.40 515.89,1029.97 509.00,1025.80 509.00,1025.80 494.00,1016.53 494.00,1016.53 494.00,1016.53 463.00,1000.93 463.00,1000.93 455.91,997.03 448.51,989.72 440.00,992.00 440.00,992.00 437.00,989.00 437.00,989.00 435.43,982.62 425.87,977.98 420.00,976.00 420.00,976.00 419.00,979.00 419.00,979.00 Z M 713.00,1062.00 C 713.00,1062.00 712.00,1062.00 712.00,1062.00 712.00,1062.00 713.00,1063.00 713.00,1063.00 713.00,1063.00 713.00,1062.00 713.00,1062.00 Z M 710.00,1067.00 C 710.00,1067.00 709.00,1067.00 709.00,1067.00 709.00,1067.00 710.00,1068.00 710.00,1068.00 710.00,1068.00 710.00,1067.00 710.00,1067.00 Z`,
    "Micoud South": `M 324.00,1038.00 C 324.00,1038.00 335.41,1033.40 335.41,1033.40 337.21,1031.62 336.91,1028.82 338.31,1026.09 338.31,1026.09 345.76,1015.00 345.76,1015.00 345.76,1015.00 362.37,993.00 362.37,993.00 362.37,993.00 366.77,986.00 366.77,986.00 370.41,980.66 377.32,967.25 384.00,966.52 387.07,966.18 402.68,971.45 406.00,973.03 406.00,973.03 418.00,980.04 418.00,980.04 418.00,980.04 425.00,982.85 425.00,982.85 425.00,982.85 436.00,990.66 436.00,990.66 436.00,990.66 452.00,999.89 452.00,999.89 452.00,999.89 463.00,1005.55 463.00,1005.55 463.00,1005.55 475.00,1012.46 475.00,1012.46 481.26,1015.35 486.88,1016.96 493.00,1020.71 493.00,1020.71 513.00,1033.29 513.00,1033.29 513.00,1033.29 521.91,1038.12 521.91,1038.12 521.91,1038.12 530.01,1044.25 530.01,1044.25 530.01,1044.25 544.96,1051.55 544.96,1051.55 549.55,1054.26 550.07,1056.45 556.00,1059.32 561.54,1062.00 564.99,1060.44 574.00,1065.04 574.00,1065.04 591.00,1076.79 591.00,1076.79 594.96,1078.85 598.92,1076.84 603.00,1076.79 607.79,1076.34 612.23,1078.35 616.00,1078.55 619.06,1078.68 623.89,1077.33 626.66,1078.55 628.94,1079.59 630.61,1083.01 632.26,1085.00 632.26,1085.00 645.00,1098.00 645.00,1098.00 645.00,1098.00 653.00,1105.74 653.00,1105.74 653.00,1105.74 660.00,1111.13 660.00,1111.13 660.00,1111.13 668.00,1118.87 668.00,1118.87 668.00,1118.87 676.00,1125.13 676.00,1125.13 676.00,1125.13 688.00,1137.00 688.00,1137.00 697.92,1146.92 703.29,1148.60 705.00,1163.00 705.00,1163.00 703.00,1163.00 703.00,1163.00 703.00,1163.00 703.00,1166.00 703.00,1166.00 703.00,1166.00 702.00,1164.00 702.00,1164.00 702.60,1168.53 701.65,1179.85 700.00,1184.00 700.00,1184.00 699.00,1178.00 699.00,1178.00 698.77,1188.06 696.38,1186.84 692.54,1195.00 689.87,1200.70 689.75,1205.20 688.23,1208.99 686.61,1213.05 683.83,1216.64 683.18,1221.09 682.65,1222.75 682.94,1233.40 683.18,1235.00 683.18,1235.00 686.00,1242.00 686.00,1242.00 686.00,1242.00 696.00,1242.00 696.00,1242.00 696.00,1242.00 696.00,1239.00 696.00,1239.00 696.00,1239.00 710.00,1237.00 710.00,1237.00 710.00,1237.00 707.00,1253.00 707.00,1253.00 707.00,1253.00 683.00,1253.91 683.00,1253.91 683.00,1253.91 662.00,1253.91 662.00,1253.91 660.77,1250.81 653.29,1249.34 650.00,1247.74 650.00,1247.74 633.00,1237.43 633.00,1237.43 629.11,1236.42 622.45,1237.90 618.00,1238.00 615.27,1230.06 606.10,1232.40 600.00,1233.34 595.61,1234.25 594.07,1233.00 590.00,1233.34 590.00,1233.34 573.00,1234.00 573.00,1234.00 573.00,1234.00 550.00,1233.00 550.00,1233.00 550.00,1233.00 550.00,1236.00 550.00,1236.00 550.00,1236.00 544.00,1236.00 544.00,1236.00 544.00,1236.00 538.18,1230.66 538.18,1230.66 538.18,1230.66 534.00,1222.00 534.00,1222.00 523.95,1222.80 521.82,1214.17 508.00,1214.00 500.01,1213.91 488.20,1214.21 481.02,1210.24 476.13,1207.53 476.41,1205.00 473.47,1201.09 470.32,1196.88 469.18,1197.61 466.00,1192.00 466.00,1192.00 464.00,1193.00 464.00,1193.00 464.00,1193.00 463.00,1192.00 463.00,1192.00 462.11,1185.80 454.95,1179.60 450.00,1176.00 450.00,1176.00 451.00,1178.00 451.00,1178.00 451.00,1178.00 439.00,1169.00 439.00,1169.00 439.00,1169.00 440.00,1166.00 440.00,1166.00 435.37,1163.30 433.86,1159.21 434.00,1154.00 434.00,1154.00 421.00,1145.00 421.00,1145.00 421.00,1145.00 422.00,1142.00 422.00,1142.00 422.00,1142.00 416.00,1136.00 416.00,1136.00 416.00,1136.00 414.00,1138.00 414.00,1138.00 414.00,1138.00 392.00,1115.00 392.00,1115.00 392.00,1115.00 394.00,1116.00 394.00,1116.00 394.00,1116.00 389.00,1113.00 389.00,1113.00 389.00,1113.00 390.00,1110.00 390.00,1110.00 390.00,1110.00 388.00,1111.00 388.00,1111.00 388.00,1111.00 388.00,1107.00 388.00,1107.00 388.00,1107.00 378.00,1104.00 378.00,1104.00 378.00,1104.00 379.00,1098.00 379.00,1098.00 376.44,1097.18 376.92,1096.55 377.00,1094.00 367.10,1088.90 357.27,1076.26 349.00,1068.00 344.81,1063.81 340.32,1060.92 339.00,1055.00 339.00,1055.00 337.00,1056.00 337.00,1056.00 335.55,1048.29 328.78,1043.87 324.00,1038.00 Z M 391.00,1112.00 C 391.00,1112.00 390.00,1112.00 390.00,1112.00 390.00,1112.00 391.00,1113.00 391.00,1113.00 391.00,1113.00 391.00,1112.00 391.00,1112.00 Z M 432.00,1152.00 C 432.00,1152.00 431.00,1152.00 431.00,1152.00 431.00,1152.00 432.00,1153.00 432.00,1153.00 432.00,1153.00 432.00,1152.00 432.00,1152.00 Z M 702.00,1168.00 C 702.00,1168.00 701.00,1168.00 701.00,1168.00 701.00,1168.00 702.00,1169.00 702.00,1169.00 702.00,1169.00 702.00,1168.00 702.00,1168.00 Z M 701.00,1174.00 C 701.00,1174.00 700.00,1174.00 700.00,1174.00 700.00,1174.00 701.00,1175.00 701.00,1175.00 701.00,1175.00 701.00,1174.00 701.00,1174.00 Z M 465.00,1191.00 C 465.00,1191.00 464.00,1191.00 464.00,1191.00 464.00,1191.00 465.00,1192.00 465.00,1192.00 465.00,1192.00 465.00,1191.00 465.00,1191.00 Z M 682.00,1224.00 C 680.75,1227.17 680.75,1228.83 682.00,1232.00 682.00,1232.00 682.00,1224.00 682.00,1224.00 Z M 534.00,1225.00 C 534.00,1225.00 535.00,1225.00 535.00,1225.00 535.00,1225.00 534.00,1226.00 534.00,1226.00 534.00,1226.00 534.00,1225.00 534.00,1225.00 Z M 537.00,1227.00 C 537.00,1227.00 536.00,1227.00 536.00,1227.00 536.00,1227.00 537.00,1228.00 537.00,1228.00 537.00,1228.00 537.00,1227.00 537.00,1227.00 Z M 538.00,1228.00 C 538.00,1228.00 537.00,1228.00 537.00,1228.00 537.00,1228.00 538.00,1229.00 538.00,1229.00 538.00,1229.00 538.00,1228.00 538.00,1228.00 Z`,
    "Vieux-Fort North": `M 373.00,1382.00 C 375.85,1375.25 375.00,1370.17 375.00,1363.00 375.00,1363.00 375.00,1333.00 375.00,1333.00 375.02,1322.93 378.98,1321.07 379.00,1311.00 379.00,1311.00 379.00,1256.00 379.00,1256.00 378.98,1244.50 376.69,1247.09 372.57,1238.00 372.57,1238.00 369.18,1227.00 369.18,1227.00 368.10,1224.45 357.75,1210.37 355.68,1208.18 355.68,1208.18 348.09,1201.82 348.09,1201.82 344.79,1198.66 333.46,1184.12 331.84,1180.00 331.21,1178.41 329.59,1171.56 329.73,1170.00 330.08,1165.85 332.86,1165.36 333.00,1157.00 333.00,1157.00 333.00,1146.00 333.00,1146.00 332.79,1133.70 321.98,1128.05 315.57,1119.00 311.24,1112.89 311.83,1108.56 310.74,1102.00 310.74,1102.00 309.51,1097.00 309.51,1097.00 308.11,1087.40 320.46,1075.15 318.72,1066.00 317.77,1061.00 313.18,1057.05 309.00,1054.59 306.38,1053.05 301.77,1051.71 302.08,1047.95 302.28,1045.34 310.05,1032.43 312.34,1031.31 313.86,1030.49 315.44,1030.67 316.96,1031.31 323.15,1034.15 326.61,1044.79 330.47,1050.00 330.47,1050.00 335.42,1056.00 335.42,1056.00 337.54,1059.18 336.79,1060.07 340.14,1064.00 340.14,1064.00 364.00,1088.00 364.00,1088.00 371.13,1095.08 378.26,1096.55 377.00,1108.00 379.01,1108.50 383.26,1109.13 384.74,1110.01 388.25,1112.11 396.79,1122.67 400.03,1126.01 400.03,1126.01 414.00,1139.83 414.00,1139.83 414.00,1139.83 422.36,1147.12 422.36,1147.12 433.48,1159.68 430.94,1162.70 438.02,1170.00 444.92,1177.11 445.23,1175.19 449.24,1178.84 449.24,1178.84 461.48,1191.58 461.48,1191.58 461.48,1191.58 465.26,1196.85 465.26,1196.85 470.10,1202.55 472.89,1203.31 476.00,1211.00 476.00,1211.00 479.00,1210.00 479.00,1210.00 479.00,1210.00 480.00,1213.00 480.00,1213.00 484.78,1212.24 494.47,1214.30 500.00,1214.94 500.00,1214.94 509.00,1214.94 509.00,1214.94 513.14,1215.23 515.65,1215.38 518.00,1219.00 518.00,1219.00 521.00,1218.00 521.00,1218.00 526.41,1224.25 526.05,1220.24 531.25,1225.06 537.23,1230.61 536.96,1234.56 542.01,1236.41 547.39,1238.37 556.32,1235.01 563.00,1235.00 575.47,1234.98 585.72,1234.18 598.00,1237.00 599.71,1234.98 600.52,1234.86 603.02,1233.93 614.07,1229.81 610.67,1238.74 623.00,1239.00 634.36,1239.23 632.22,1240.41 641.00,1246.24 643.75,1248.07 650.84,1251.51 654.00,1252.66 657.03,1253.75 668.18,1256.89 671.00,1256.89 675.73,1256.89 679.89,1253.91 688.00,1255.15 693.60,1256.00 692.78,1258.84 700.00,1260.00 695.04,1265.80 688.58,1264.81 682.00,1262.79 679.40,1262.00 673.64,1261.19 672.17,1264.31 671.23,1266.30 672.64,1267.98 674.15,1269.11 678.36,1272.24 680.24,1270.10 685.00,1278.00 676.60,1279.39 677.01,1285.01 677.00,1292.00 677.00,1292.00 672.74,1288.97 672.74,1288.97 667.99,1286.57 663.51,1288.47 663.06,1294.00 662.22,1304.34 669.12,1304.55 670.76,1309.09 671.86,1312.14 667.96,1321.58 662.00,1321.72 656.64,1321.85 653.94,1316.08 650.97,1314.91 646.57,1313.17 644.99,1318.73 645.07,1322.00 645.24,1328.56 652.15,1336.41 640.00,1339.76 638.34,1339.95 636.69,1339.95 635.00,1339.76 635.00,1339.76 631.71,1330.00 631.71,1330.00 630.03,1324.08 629.75,1318.68 622.00,1318.17 615.69,1317.55 613.33,1320.16 610.13,1318.17 606.92,1316.39 605.09,1310.19 601.68,1307.60 599.39,1305.86 595.78,1305.82 593.00,1306.06 591.29,1306.20 589.75,1306.42 588.39,1307.60 585.06,1310.49 587.57,1313.97 585.35,1316.40 583.83,1318.08 581.02,1317.84 579.31,1319.02 576.54,1320.94 577.01,1325.02 577.00,1328.00 573.21,1328.01 569.43,1327.88 566.15,1330.15 561.74,1333.18 563.16,1338.64 567.19,1340.98 569.44,1342.28 572.47,1341.84 575.00,1342.26 582.92,1343.57 579.09,1344.00 589.00,1344.00 587.94,1350.10 585.95,1347.12 581.17,1351.26 581.17,1351.26 576.83,1355.71 576.83,1355.71 574.28,1357.93 572.37,1358.24 570.54,1360.30 570.54,1360.30 564.15,1371.00 564.15,1371.00 562.48,1373.87 560.72,1379.14 556.95,1379.43 551.53,1379.83 539.74,1369.76 536.09,1366.01 532.98,1362.82 530.95,1359.84 526.00,1360.17 520.72,1360.53 516.76,1365.32 513.00,1367.02 510.42,1368.18 507.76,1367.99 505.00,1368.00 505.00,1368.00 491.00,1368.00 491.00,1368.00 480.56,1368.07 483.75,1371.35 477.71,1373.52 471.27,1375.84 464.75,1375.89 458.00,1376.00 451.48,1376.11 452.82,1377.06 448.83,1377.95 448.83,1377.95 435.04,1377.95 435.04,1377.95 429.55,1378.79 432.68,1379.98 423.00,1380.06 423.00,1380.06 409.04,1380.06 409.04,1380.06 403.55,1380.79 406.68,1381.98 397.00,1382.00 397.00,1382.00 373.00,1382.00 373.00,1382.00 Z M 395.00,1120.00 C 395.00,1120.00 394.00,1120.00 394.00,1120.00 394.00,1120.00 395.00,1121.00 395.00,1121.00 395.00,1121.00 395.00,1120.00 395.00,1120.00 Z M 422.00,1147.00 C 422.00,1147.00 421.00,1147.00 421.00,1147.00 421.00,1147.00 422.00,1148.00 422.00,1148.00 422.00,1148.00 422.00,1147.00 422.00,1147.00 Z M 423.00,1148.00 C 423.00,1148.00 422.00,1148.00 422.00,1148.00 422.00,1148.00 423.00,1149.00 423.00,1149.00 423.00,1149.00 423.00,1148.00 423.00,1148.00 Z M 536.00,1231.00 C 536.00,1231.00 535.00,1231.00 535.00,1231.00 535.00,1231.00 536.00,1232.00 536.00,1232.00 536.00,1232.00 536.00,1231.00 536.00,1231.00 Z`
};

export function InteractiveMap2({ constituencies, selectedConstituencyId, election, onConstituencyClick, onLeaningChange, onPredictionChange, electionResults, previousElectionResults, partyLogos, isMakeYourOwn }: InteractiveMap2Props) {
    const constituencyMap = useMemo(() => {
        const map = new Map<string, Constituency>();
        const anseLaRayeCanariesId = '4CRZlKXDXQCBPzvXjYeD';

        const anseLaRayeConstituency = constituencies.find(c => c.id === anseLaRayeCanariesId);
        if (anseLaRayeConstituency) {
            map.set("Anse-La-Raye/Canaries", anseLaRayeConstituency);
        } else {
            // Create a fallback if not found in Firestore
            const fallback: Constituency = {
                id: anseLaRayeCanariesId,
                name: 'Anse-la-Raye/Canaries',
                demographics: { registeredVoters: 0 },
                politicalLeaning: isMakeYourOwn ? 'unselected' : 'tossup',
            };
            map.set("Anse-La-Raye/Canaries", fallback);
        }

        const remainingConstituencies = constituencies.filter(c => c.id !== anseLaRayeCanariesId);

        for (const constituency of remainingConstituencies) {
            map.set(constituency.name, constituency);
        }

        // Ensure all 17 constituencies from SVGPaths are in the map
        for (const name in SVGPaths) {
            if (!map.has(name) && name !== "Anse-La-Raye/Canaries") {
                 const fallback: Constituency = {
                    id: name, // Use name as a fallback ID
                    name: name,
                    demographics: { registeredVoters: 0 },
                    politicalLeaning: isMakeYourOwn ? 'unselected' : 'tossup',
                };
                map.set(name, fallback);
            }
        }
        
        return map;
    }, [constituencies, isMakeYourOwn]);

    return (
        <svg
            xmlns="http://www.w3.org/2000/svg"
            version="1.1"
            width="100%"
            height="100%"
            viewBox="0 0 800 1533"
        >
            <defs>
                <pattern id="stripes" patternUnits="userSpaceOnUse" width="10" height="10" patternTransform="rotate(45)">
                    <rect width="10" height="10" fill="#2980B9"></rect>
                    <line x1="0" y1="0" x2="0" y2="10" stroke="#E74C3C" strokeWidth="6"></line>
                </pattern>
                <pattern id="red-white-stripes" patternUnits="userSpaceOnUse" width="10" height="10" patternTransform="rotate(45)">
                    <rect width="10" height="10" fill="#E74C3C"></rect>
                    <line x1="0" y1="0" x2="0" y2="10" stroke="white" strokeWidth="6"></line>
                </pattern>
            </defs>
            {Object.entries(SVGPaths).map(([name, pathData]) => {
                const constituency = constituencyMap.get(name);
                if (!constituency) return null;
                
                const electionYear = election?.year;
                const isSpecialYear = electionYear === 2021 || election?.isCurrent;

                const result = electionResults?.find(r => r.constituencyId === constituency.id);
                const slpWon = result && result.slpVotes > result.uwpVotes;
                
                let isStriped = false;
                let stripesId = "stripes";
                
                if (isSpecialYear) {
                    if (name === 'Castries North') {
                        isStriped = true;
                        stripesId = "stripes";
                    } else if (name === 'Castries Central') {
                        isStriped = true;
                        stripesId = "red-white-stripes";
                    }
                }
                
                const { className: leaningClassName } = getLeaningInfo(constituency.politicalLeaning, isMakeYourOwn);
                const isSelected = constituency.id === selectedConstituencyId;

                return (
                    <Popover key={constituency.id}>
                        <PopoverTrigger asChild>
                            <path
                                d={pathData}
                                id={constituency.name}
                                className={cn(
                                    "cursor-pointer transition-all duration-300",
                                    !isStriped && leaningClassName,
                                    "stroke-white stroke-2 hover:stroke-black hover:stroke-[4]",
                                    isSelected ? "stroke-black stroke-[4]" : ""
                                )}
                                fill={isStriped ? `url(#${stripesId})` : undefined}
                                onClick={() => onConstituencyClick(constituency.id)}
                            />
                        </PopoverTrigger>
                        <PopoverContent className="w-auto" side="right">
                           <ConstituencyPopoverContent 
                                constituency={constituency}
                                election={election}
                                onLeaningChange={onLeaningChange ? (leaning) => onLeaningChange(constituency.id, leaning) : undefined}
                                onPredictionChange={onPredictionChange ? (slp, uwp) => onPredictionChange(constituency.id, slp, uwp) : undefined}
                                electionResults={electionResults}
                                previousElectionResults={previousElectionResults}
                                partyLogos={partyLogos}
                                isMakeYourOwn={isMakeYourOwn}
                           />
                        </PopoverContent>
                    </Popover>
                );
            })}
        </svg>
    );
}
